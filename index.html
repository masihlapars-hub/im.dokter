<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dokter-Dokteran ‚Äî Tebak Diagnosis (Tiered)</title>
<meta name="description" content="Game edukasi dokter-dokteran: pasien masuk, baca gejala, tebak diagnosis. Ada tier, profil dokter, 5 avatar, musik & SFX.">
<style>
  :root{
    --bg:#0e1016; --panel:#151a22; --panel2:#111620; --line:#252c3a; --text:#e9edf5; --muted:#aeb6c5;
    --mint:#6EE7C8; --teal:#16A085; --pink:#FF77B7; --amber:#FFC857; --red:#FF5A6E; --green:#58d68d;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{max-width:1200px;margin:0 auto;padding:14px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:10px 0 14px;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
  .pill{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:6px 10px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .panel{background:var(--panel2);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1060px){ .grid{grid-template-columns:340px 1fr 320px} }
  .vital{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
  .vital h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
  .bar{height:10px;background:#0c0f14;border:1px solid #1e2533;border-radius:10px;overflow:hidden}
  .bar>span{display:block;height:100%;transition:width .4s ease, background .2s ease}
  .case{min-height:260px;display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){ .case{grid-template-columns:1fr 280px} }
  .nayaWrap{display:grid;place-items:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px}
  .actions{display:grid;grid-template-columns:1fr;gap:8px}
  button.btn{
    background:linear-gradient(180deg,#1b2230,#161c28);border:1px solid var(--line);color:var(--text);
    padding:12px;border-radius:12px;cursor:pointer;display:flex;gap:10px;align-items:center;justify-content:space-between;
    transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease
  }
  button.btn:hover{border-color:#3a455c;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  button.btn:active{transform:translateY(1px)}
  .btn .name{font-size:15px;font-weight:700}
  .btn .tag{font-size:12px;color:var(--muted)}
  .btn.correct{outline:2px solid #2ecc71}
  .btn.wrong{outline:2px solid #ff5a6e}
  .footerRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-top:8px}
  .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .small{color:var(--muted);font-size:13px}
  .select, .input{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:12px}
  .btnBig{background:linear-gradient(180deg,#1f2632,#161c28);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btnBig:disabled{opacity:.6;cursor:not-allowed}
  .log{white-space:pre-wrap}
  /* Avatar (5 karakter) */
  .avatar{width:36px;height:36px;border-radius:50%;border:2px solid #2b3344;display:grid;place-items:center;overflow:hidden}
  .naya{width:100%;height:100%}
  .blink{animation:blink 5s infinite}
  @keyframes blink{0%,97%,100%{transform:scaleY(1)}98%{transform:scaleY(0.05)}}
  .bounce{animation:bounce .5s ease-out}
  @keyframes bounce{0%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  .shake{animation:shake .2s ease-in-out}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  /* Modal Profile */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{background:var(--panel2);border:1px solid var(--line);border-radius:16px;max-width:720px;width:100%;padding:16px}
  .avatars{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:10px}
  .avatarCard{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer;display:grid;gap:8px;place-items:center}
  .avatarCard.active{outline:2px solid #6EE7C8}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="avatar" id="avatarSmall"></div>
      <h1>Dokter-Dokteran</h1>
      <span class="pill"><span id="docNameLabel">Dr. ‚Äî</span><span>‚Ä¢</span><span id="tierLabel">Tier 1 ‚Äî Dokter Belajar (0/20)</span></span>
    </div>
    <div class="hud">
      <div class="pill">
        <span class="small">Skor</span>&nbsp;<b id="score">0</b>
        <span class="small">‚Ä¢</span>
        <span class="small">Best</span>&nbsp;<b id="best">0</b>
      </div>
      <div class="pill" title="Volume (musik ‚Ä¢ efek)">
        üîä
        <input id="volMusic" type="range" min="0" max="1" step="0.01" value="0.6" style="width:90px">
        <input id="volFx" type="range" min="0" max="1" step="0.01" value="0.8" style="width:90px">
      </div>
      <select id="tierSel" class="select">
        <option value="1">Tier 1 ‚Äî Dokter Belajar (20)</option>
        <option value="2">Tier 2 ‚Äî Dokter Magang (20)</option>
        <option value="3">Tier 3 ‚Äî Dokter Ahli (30)</option>
      </select>
      <button id="profileBtn" class="btnBig">Profil Dokter</button>
      <button id="nextBtn" class="btnBig">Panggil Pasien</button>
    </div>
  </header>

  <section class="grid">
    <!-- kiri: identitas & vital -->
    <div>
      <div class="vital">
        <h3>Identitas</h3>
        <div class="log" id="ident">‚Äî</div>
      </div>
      <div class="vital">
        <h3>Vital</h3>
        <div class="small">HR: <b id="hr">‚Äî</b> bpm</div>
        <div class="bar" style="margin-bottom:6px"><span id="hrB" style="width:0%"></span></div>
        <div class="small">RR: <b id="rr">‚Äî</b> /min</div>
        <div class="bar" style="margin-bottom:6px"><span id="rrB" style="width:0%"></span></div>
        <div class="small">SpO‚ÇÇ: <b id="spo">‚Äî</b>%</div>
        <div class="bar" style="margin-bottom:6px"><span id="spoB" style="width:0%"></span></div>
        <div class="small">BP: <b id="bp">‚Äî</b> mmHg</div>
        <div class="bar"><span id="bpB" style="width:0%"></span></div>
      </div>
      <div class="vital">
        <h3>Catatan</h3>
        <div class="small">Game edukasi, bukan panduan klinis. Latihan pola gejala & penalaran diagnosis.</div>
      </div>
    </div>

    <!-- tengah: narasi kasus + avatar besar -->
    <div class="panel case">
      <div>
        <div class="small">Keluhan Utama</div>
        <h2 id="chief" style="margin:6px 0 10px">‚Äî</h2>
        <div class="small">Riwayat Singkat</div>
        <div id="story" class="log" style="margin-bottom:8px">Tekan <b>Panggil Pasien</b> untuk mulai.</div>
        <div class="small">Pemeriksaan Fisik</div>
        <div id="exam" class="log">‚Äî</div>
        <div id="explain" class="log" style="margin-top:10px"></div>
      </div>
      <div class="nayaWrap">
        <div id="avatarBig" style="width:180px;height:180px"></div>
        <div id="nayaTalk" class="small">‚ÄúGanbatte, dok!‚Äù ‚ú®</div>
      </div>
    </div>

    <!-- kanan: opsi diagnosis -->
    <div class="panel">
      <div class="small">Pilih Diagnosis</div>
      <div class="actions" id="options"></div>
      <div class="footerRow">
        <div class="small">Peluang: <b id="tries">‚Äî</b></div>
        <div class="small">Progress Tier: <b id="tierProgress">0</b>/<b id="tierMax">20</b></div>
        <button id="revealBtn" class="btnBig" disabled>Lihat Penjelasan</button>
      </div>
    </div>
  </section>
</div>

<!-- Modal Profile -->
<div class="modal" id="profileModal" role="dialog" aria-modal="true" aria-label="Profil Dokter">
  <div class="box">
    <h3 style="margin:0 0 8px">Profil Dokter</h3>
    <div class="small">Isi nama dan pilih karakter. Tersimpan otomatis.</div>
    <div style="display:flex;gap:10px;align-items:center;margin:10px 0">
      <label class="small">Nama Dokter:</label>
      <input id="nameInput" class="input" placeholder="Mis. Azzam" style="min-width:220px">
      <button id="saveProfile" class="btnBig">Simpan</button>
      <button id="closeProfile" class="btnBig" style="background:#262e3d">Tutup</button>
    </div>
    <div class="avatars" id="avatarChoices"></div>
  </div>
</div>

<script>
/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

/* ============ Storage ============ */
function getStore(k,d){ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;} }
function setStore(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ============ Audio (WebAudio) ============ */
let audioCtx=null, fxGain=null, musicGain=null, started=false, musicTimer=null, musicStep=0, tempo=120;
function ensureAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  fxGain = audioCtx.createGain(); fxGain.gain.value = +$('#volFx').value;
  musicGain = audioCtx.createGain(); musicGain.gain.value = +$('#volMusic').value;
  fxGain.connect(audioCtx.destination); musicGain.connect(audioCtx.destination);
  startMusic();
}
function setFxVol(v){ if(fxGain) fxGain.gain.value=v; }
function setMusicVol(v){ if(musicGain) musicGain.gain.value=v; }
function tone({f=440,d=0.12,type='sine',g=0.25}){
  if (!audioCtx) return;
  const o=audioCtx.createOscillator(), gain=audioCtx.createGain();
  o.type=type; o.frequency.value=f; gain.gain.value=g;
  o.connect(gain); gain.connect(fxGain);
  o.start(); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
  o.stop(audioCtx.currentTime + d);
}
function clickFx(){ tone({f:420,d:0.06,type:'triangle',g:0.18}); }
function rightFx(){ tone({f:880,d:0.14,type:'sine',g:0.22}); }
function wrongFx(){ tone({f:120,d:0.16,type:'sawtooth',g:0.18}); }
function hintFx(){ tone({f:600,d:0.08,type:'square',g:0.16}); }
function startMusic(){
  if (musicTimer) clearInterval(musicTimer);
  const beatMs = 60000/tempo;
  musicTimer = setInterval(()=>{
    // kick-ish
    if (musicStep%4===0) tone({f:60,d:0.08,type:'sine',g:0.10});
    // pluck lead
    const scales={1:[0,3,5,7,10],2:[0,2,5,7,9],3:[0,2,3,7,9]};
    const tierVal = +$('#tierSel').value;
    const scale = scales[tierVal] || scales[1];
    const root=pick([196,220,247]);
    const f = root*Math.pow(2, scale[musicStep%scale.length]/12);
    tone({f, d:0.14, type:'triangle', g:0.06});
    musicStep++;
  }, beatMs);
}
$('#volMusic').addEventListener('input', e=>setMusicVol(+e.target.value));
$('#volFx').addEventListener('input', e=>setFxVol(+e.target.value));
document.body.addEventListener('pointerdown', ()=>{ if(!started){ ensureAudio(); started=true; }}, {once:true});

/* ============ Avatar (5 karakter) ============ */
const AVATARS = [
  {id:'naya', name:'Naya', desc:'Chibi pink ceria', svg:(w=180,h=180)=>`
    <svg class="naya" viewBox="0 0 200 200" width="${w}" height="${h}">
      <circle cx="60" cy="60" r="28" fill="#FF77B7" opacity=".9"/>
      <circle cx="140" cy="60" r="28" fill="#FF77B7" opacity=".9"/>
      <circle cx="100" cy="90" r="48" fill="#ffd6e7" stroke="#e9a3c3" stroke-width="3"/>
      <g><ellipse class="blink" cx="82" cy="88" rx="8" ry="10" fill="#1b1e27"/>
         <ellipse class="blink" cx="118" cy="88" rx="8" ry="10" fill="#1b1e27"/></g>
      <path d="M85 110 q15 12 30 0" stroke="#e0628f" stroke-width="4" fill="none" stroke-linecap="round"/>
      <rect x="70" y="130" width="60" height="50" rx="12" fill="#6EE7C8" stroke="#16A085" stroke-width="3"/>
      <circle cx="100" cy="150" r="10" fill="#0e1016" stroke="#e9edf5" stroke-width="3"/>
    </svg>`},
  {id:'raka', name:'Raka', desc:'Scrub biru, rambut rapi', svg:(w=180,h=180)=>`
    <svg viewBox="0 0 200 200" width="${w}" height="${h}">
      <circle cx="100" cy="90" r="48" fill="#ffd9bf" stroke="#d6a37a" stroke-width="3"/>
      <rect x="52" y="50" width="96" height="38" rx="18" fill="#3da8ff"/>
      <rect x="70" y="130" width="60" height="50" rx="12" fill="#3da8ff" stroke="#1e77d0" stroke-width="3"/>
      <g><ellipse class="blink" cx="82" cy="88" rx="8" ry="10" fill="#1b1e27"/>
         <ellipse class="blink" cx="118" cy="88" rx="8" ry="10" fill="#1b1e27"/></g>
      <path d="M85 112 q15 -10 30 0" stroke="#8b4f3a" stroke-width="4" fill="none" stroke-linecap="round"/>
      <rect x="75" y="147" width="50" height="8" rx="4" fill="#0e1016"/>
    </svg>`},
  {id:'alya', name:'Alya', desc:'Jilbab mint, senyum kalem', svg:(w=180,h=180)=>`
    <svg viewBox="0 0 200 200" width="${w}" height="${h}">
      <path d="M40,110 a60,60 0 1,1 120,0 v30 h-120z" fill="#6EE7C8" stroke="#16A085" stroke-width="3"/>
      <circle cx="100" cy="90" r="40" fill="#ffe5d6" stroke="#dbb8a5" stroke-width="3"/>
      <g><ellipse class="blink" cx="85" cy="92" rx="7" ry="9" fill="#1b1e27"/>
         <ellipse class="blink" cx="115" cy="92" rx="7" ry="9" fill="#1b1e27"/></g>
      <path d="M85 110 q15 8 30 0" stroke="#b06a5a" stroke-width="4" fill="none" stroke-linecap="round"/>
    </svg>`},
  {id:'dimas', name:'Dimas', desc:'Steto besar, jaket lab', svg:(w=180,h=180)=>`
    <svg viewBox="0 0 200 200" width="${w}" height="${h}">
      <circle cx="100" cy="90" r="48" fill="#ffd9bf" stroke="#d6a37a" stroke-width="3"/>
      <rect x="60" y="130" width="80" height="50" rx="12" fill="#e9edf5" stroke="#aeb6c5" stroke-width="3"/>
      <circle cx="90" cy="150" r="10" fill="#0e1016" stroke="#e9edf5" stroke-width="3"/>
      <circle cx="110" cy="150" r="10" fill="#0e1016" stroke="#e9edf5" stroke-width="3"/>
      <path d="M90 150 q10 15 20 0" stroke="#16A085" stroke-width="4" fill="none"/>
      <g><ellipse class="blink" cx="82" cy="88" rx="8" ry="10" fill="#1b1e27"/>
         <ellipse class="blink" cx="118" cy="88" rx="8" ry="10" fill="#1b1e27"/></g>
    </svg>`},
  {id:'sora', name:'Sora', desc:'Kacamata, rambut ungu', svg:(w=180,h=180)=>`
    <svg viewBox="0 0 200 200" width="${w}" height="${h}">
      <rect x="48" y="50" width="104" height="50" rx="22" fill="#9d72ff"/>
      <circle cx="100" cy="95" r="45" fill="#ffe1ef" stroke="#e4a8c9" stroke-width="3"/>
      <rect x="70" y="85" width="24" height="14" rx="6" fill="none" stroke="#2c2f3a" stroke-width="3"/>
      <rect x="106" y="85" width="24" height="14" rx="6" fill="none" stroke="#2c2f3a" stroke-width="3"/>
      <rect x="94" y="91" width="12" height="2" fill="#2c2f3a"/>
      <g><ellipse class="blink" cx="82" cy="100" rx="4" ry="6" fill="#1b1e27"/>
         <ellipse class="blink" cx="118" cy="100" rx="4" ry="6" fill="#1b1e27"/></g>
      <path d="M85 118 q15 10 30 0" stroke="#a46386" stroke-width="4" fill="none"/>
      <rect x="70" y="140" width="60" height="40" rx="12" fill="#9d72ff" stroke="#6b49c7" stroke-width="3"/>
    </svg>`},
];

/* Render avatar choices in modal */
function renderAvatarChoices(){
  const wrap = $('#avatarChoices'); wrap.innerHTML='';
  const current = getStore('dok_avatar','naya');
  AVATARS.forEach(a=>{
    const div = document.createElement('div');
    div.className = 'avatarCard'+(current===a.id?' active':'');
    div.dataset.id = a.id;
    div.innerHTML = `${a.svg(120,120)}<div><b>${a.name}</b><div class="small">${a.desc}</div></div>`;
    div.addEventListener('click', ()=>{
      $$('.avatarCard').forEach(x=>x.classList.remove('active'));
      div.classList.add('active');
      setStore('dok_avatar', a.id);
      drawAvatars();
    });
    wrap.appendChild(div);
  });
}

/* Draw small & big avatar */
function drawAvatars(){
  const id = getStore('dok_avatar','naya');
  const def = AVATARS.find(x=>x.id===id) || AVATARS[0];
  $('#avatarSmall').innerHTML = def.svg(36,36);
  $('#avatarBig').innerHTML = def.svg(180,180);
}

/* ============ Names ============ */
const FIRST = ['Alya','Bima','Citra','Dimas','Eka','Farah','Gilang','Hani','Indra','Joko','Kirana','Lutfi','Maya','Nabila','Oki','Putra','Qori','Raka','Salsa','Teguh','Ulfa','Vina','Wawan','Xavier','Yani','Zidan'];
const LAST  = ['Pratama','Wibowo','Saputra','Putri','Nugraha','Permata','Wijaya','Herlambang','Mahesa','Mahardika','Arya','Salsabila','Gumilang','Fitriani','Ramadhan','Siregar','Hutagalung','Santoso','Cahyadi','Anggraini','Maulana','Prameswari','Kartika','Wardana','Nareswari'];
const usedPatients = new Set();
function uniquePatient(){
  for (let i=0;i<5000;i++){
    const name = pick(FIRST)+' '+pick(LAST);
    if (!usedPatients.has(name)){ usedPatients.add(name); return name; }
  }
  usedPatients.clear();
  return uniquePatient();
}

/* ============ Disease Bank (by tier) ============ */
function vitals({hr=[70,100], rr=[12,20], spo=[96,100], sbp=[110,130], dbp=[70,85]}={}){
  const HR=rnd(hr[0],hr[1]), RR=rnd(rr[0],rr[1]), SpO=rnd(spo[0],spo[1]), BP=[rnd(sbp[0],sbp[1]),rnd(dbp[0],dbp[1])];
  return {HR,RR,SpO,BP};
}
function makeCase({name, tag, chief, story, exam, v, why}){ return {name,tag,chief,story,exam,v,why}; }

const GEN = {
  Asma: ()=>{ const v=vitals({rr:[24,34], spo:[86,92], hr:[100,120]}); return makeCase({
    name:'Asma eksaserbasi', tag:'Pulmo',
    chief:'Sesak napas dan mengi',
    story:`${pick(['Sejak beberapa jam','Sejak tadi malam'])} terasa sesak. Riwayat asma, pemicu ${pick(['debu','dingin','asap rokok'])}.`,
    exam:`Wheezing difus, pakai otot bantu, tidak ada stridor. Bicara ${pick(['terputus-putus','pendek'])}.`, v,
    why:'Mengi difus + riwayat asma + pemicu khas ‚Üí paling sesuai asma.'
  });},
  Pn: ()=>{ const v=vitals({rr:[22,30], spo:[88,94], hr:[90,110]}); return makeCase({
    name:'Pneumonia komunitas', tag:'Infeksi',
    chief:'Demam, batuk berdahak, sesak',
    story:`Demam ${pick(['38.5¬∞C','39¬∞C'])} ${pick(['2 hari','4 hari'])}, batuk berdahak kekuningan.`,
    exam:`Crackles ${pick(['basal kanan','basal kiri'])}, egophony (+).`, v,
    why:'Demam + batuk produktif + crackles ‚Üí pneumonia.'
  });},
  ACS: ()=>{ const v=vitals({hr:[80,110], rr:[16,24], spo:[93,98], sbp:[100,140], dbp:[60,90]}); return makeCase({
    name:'Infark Miokard (ACS)', tag:'Kardiovaskular',
    chief:'Nyeri dada menekan',
    story:`>20 menit, menjalar ke lengan/rahang, mual dingin. Risiko: ${pick(['merokok','DM','hipertensi'])}.`,
    exam:`Diaforesis, nyeri tidak berubah dengan posisi.`, v,
    why:'Nyeri tipikal + faktor risiko ‚Üí pikir ACS.'
  });},
  HF: ()=>{ const v=vitals({rr:[22,30], spo:[88,95], hr:[90,120]}); return makeCase({
    name:'Gagal Jantung Akut', tag:'Kardiovaskular',
    chief:'Sesak saat aktivitas/berbaring',
    story:`Ortopnea, PND, edema kaki. Riwayat hipertensi.`,
    exam:`Crackles bilateral, JVP tinggi, edema.`, v,
    why:'Ortopnea/PND + edema perifer ‚Üí gagal jantung.'
  });},
  DKA: ()=>{ const v=vitals({rr:[24,32], spo:[94,98], hr:[95,120], sbp:[95,120], dbp:[55,75]}); return makeCase({
    name:'DKA (Ketoasidosis Diabetik)', tag:'Metabolik',
    chief:'Mual muntah, napas cepat',
    story:`DM tipe 1, poliuria/polidipsia, nafas Kussmaul, bau buah.`,
    exam:`Dehidrasi, kesadaran menurun.`, v,
    why:'DM + Kussmaul + aseton ‚Üí DKA.'
  });},
  Hypo: ()=>{ const v=vitals({hr:[90,110], rr:[12,20], spo:[96,100]}); return makeCase({
    name:'Hipoglikemia', tag:'Metabolik',
    chief:'Lemas, keringat dingin, bingung',
    story:`Setelah olahraga tanpa makan. Tremor, lapar berat.`,
    exam:`Gelisah, bisa kejang bila berat.`, v,
    why:'Gejala adrenergik + neuroglikopenik ‚Üí hipoglikemia.'
  });},
  Stroke: ()=>{ const v=vitals({hr:[70,100], rr:[12,22], spo:[94,99]}); return makeCase({
    name:'Stroke iskemik', tag:'Neurologi',
    chief:'Lemah separuh tubuh mendadak',
    story:`Onset mendadak, afasia/wajah mencong. Risiko: ${pick(['HT','AF','DM'])}.`,
    exam:`FAST positif, defisit fokal.`, v,
    why:'Defisit fokal mendadak persisten ‚Üí stroke.'
  });},
  Meningitis: ()=>{ const v=vitals({hr:[90,120], rr:[16,26], spo:[94,99]}); return makeCase({
    name:'Meningitis', tag:'Infeksi',
    chief:'Demam, sakit kepala hebat',
    story:`Fotofobia, ${pick(['kaku kuduk','muntah proyektil'])}.`,
    exam:`Kaku kuduk (+), bisa petekie.`, v,
    why:'Demam + kaku kuduk + fotofobia ‚Üí meningitis.'
  });},
  Sepsis: ()=>{ const v=vitals({hr:[110,130], rr:[22,30], spo:[90,96], sbp:[85,100], dbp:[50,65]}); return makeCase({
    name:'Sepsis (pneumonia fokus)', tag:'Infeksi',
    chief:'Demam tinggi, lemas, tekanan turun',
    story:`Riwayat batuk/sesak sebelumnya.`, exam:`Perfusi jelek, ekstremitas dingin/hangat.`, v,
    why:'Hipotensi + infeksi + takikardi ‚Üí sepsis.'
  });},
  Ana: ()=>{ const v=vitals({hr:[100,130], rr:[22,32], spo:[85,94], sbp:[80,100], dbp:[45,65]}); return makeCase({
    name:'Anafilaksis', tag:'Alergi',
    chief:'Sesak & bengkak bibir setelah alergen',
    story:`Urtikaria generalisata, suara serak setelah ${pick(['udang','kacang','obat'])}.`,
    exam:`Wheezing/stridor, hipotensi.`, v,
    why:'‚â•2 sistem + hipotensi setelah paparan ‚Üí anafilaksis.'
  });},
  PTX: ()=>{ const v=vitals({hr:[90,110], rr:[20,28], spo:[90,98]}); return makeCase({
    name:'Pneumotoraks spontan', tag:'Pulmo',
    chief:'Nyeri dada tajam mendadak',
    story:`Pleuritik, pada ${pick(['perokok muda tinggi','COPD'])}.`,
    exam:`Suara napas menurun sepihak, hipersonor.`, v,
    why:'Nyeri pleuritik + suara napas turun sepihak ‚Üí pneumotoraks.'
  });},
  PE: ()=>{ const v=vitals({hr:[100,130], rr:[22,30], spo:[88,96]}); return makeCase({
    name:'Emboli paru', tag:'Pulmo',
    chief:'Sesak mendadak, nyeri dada pleuritik',
    story:`Faktor risiko tromboemboli: ${pick(['imobilisasi','OC','DVT'])}.`,
    exam:`Takipnea, bisa tanda DVT.`, v,
    why:'Onset akut + faktor risiko + hipoksemia ‚Üí curiga EP.'
  });},
  Appy: ()=>{ const v=vitals({hr:[88,110], rr:[12,22], spo:[96,100]}); return makeCase({
    name:'Apendisitis akut', tag:'GI',
    chief:'Nyeri perut kanan bawah',
    story:`Awalnya epigastrium/pusar lalu migrasi ke RLQ, mual.`, exam:`Titik McBurney +, rebound tenderness.`, v,
    why:'Migrasi nyeri + RLQ khas ‚Üí apendisitis.'
  });},
  Chole: ()=>{ const v=vitals({hr:[88,105], rr:[12,20], spo:[96,100]}); return makeCase({
    name:'Kolesistitis akut', tag:'GI',
    chief:'Nyeri perut kanan atas',
    story:`Setelah makan berlemak, mual, demam ringan.`, exam:`Murphy (+).`, v,
    why:'RUQ + Murphy (+) ‚Üí kolesistitis.'
  });},
  Pancrea: ()=>{ const v=vitals({hr:[96,120], rr:[16,24], spo:[95,99]}); return makeCase({
    name:'Pankreatitis akut', tag:'GI',
    chief:'Nyeri epigastrium ke punggung',
    story:`Setelah alkohol/makan besar, muntah.`, exam:`Nyeri epigastrium; tanda Cullen/Grey-Turner pada berat.`, v,
    why:'Epigastrium ‚Üí punggung + pemicu ‚Üí pankreatitis.'
  });},
  UGIB: ()=>{ const v=vitals({hr:[100,125], rr:[16,24], spo:[94,99], sbp:[85,105], dbp:[50,65]}); return makeCase({
    name:'Perdarahan GI atas', tag:'GI',
    chief:'Muntah darah / melena',
    story:`Lemas, pusing berdiri; riwayat NSAID/sirosis mungkin.`, exam:`Pucat, hipotensi ortostatik.`, v,
    why:'Hematemesis/melena + hipotensi ‚Üí UGIB.'
  });},
  Stone: ()=>{ const v=vitals({hr:[80,105], rr:[12,20], spo:[96,100]}); return makeCase({
    name:'Batu ginjal', tag:'GU',
    chief:'Nyeri pinggang ke lipat paha',
    story:`Kolik, gelisah, disuria/hematuria.`, exam:`Nyeri ketok CVA sisi terdampak.`, v,
    why:'Kolik menjalar + hematuria ‚Üí nefrolitiasis.'
  });},
  Pyelo: ()=>{ const v=vitals({hr:[90,110], rr:[12,20], spo:[96,100]}); return makeCase({
    name:'Pielonefritis', tag:'GU',
    chief:'Demam, nyeri pinggang',
    story:`Disuria, sering BAK, mual.`, exam:`Nyeri ketok CVA, demam.`, v,
    why:'Demam + nyeri CVA + gejala urin ‚Üí pielonefritis.'
  });},
  Ectopic: ()=>{ const v=vitals({hr:[90,110], rr:[12,20], spo:[96,100], sbp:[95,120], dbp:[55,80]}); return makeCase({
    name:'Kehamilan ektopik', tag:'Obgyn',
    chief:'Nyeri perut bawah + perdarahan',
    story:`Usia subur, terlambat haid, test hamil (+).`, exam:`Nyeri adneksa; tanda peritoneal jika ruptur.`, v,
    why:'Amenore + nyeri + perdarahan ‚Üí curiga ektopik.'
  });},
  PreE: ()=>{ const v=vitals({hr:[80,100], rr:[12,20], spo:[96,100], sbp:[140,170], dbp:[90,110]}); return makeCase({
    name:'Preeklampsia', tag:'Obgyn',
    chief:'Sakit kepala, pandangan kabur (hamil >20 mg)',
    story:`Bengkak, kadang nyeri epigastrium.`, exam:`Tekanan darah tinggi, edema.`, v,
    why:'HT pada hamil >20 mg + gejala visual ‚Üí preeklampsia.'
  });},
  Dengue: ()=>{ const v=vitals({hr:[90,110], rr:[12,20], spo:[96,100], sbp:[95,120], dbp:[55,80]}); return makeCase({
    name:'Dengue', tag:'Tropis',
    chief:'Demam tinggi, nyeri belakang mata',
    story:`Mialgia, ruam, perdarahan gusi/petekie mungkin.`, exam:`Uji torniket (+).`, v,
    why:'Demam + retroorbital + ruam/bleeding ‚Üí dengue.'
  });},
  Typhoid: ()=>{ const v=vitals({hr:[80,100], rr:[12,20], spo:[96,100]}); return makeCase({
    name:'Demam tifoid', tag:'Tropis',
    chief:'Demam naik bertahap, nyeri perut',
    story:`Diare/konstipasi, riwayat makanan kurang bersih.`, exam:`Rose spots jarang tapi khas.`, v,
    why:'Demam bertahap + keluhan GI + risiko makanan ‚Üí tifoid.'
  });},
  Malaria: ()=>{ const v=vitals({hr:[90,120], rr:[12,22], spo:[95,100]}); return makeCase({
    name:'Malaria', tag:'Tropis',
    chief:'Demam hilang-timbul',
    story:`Menggigil, keringat; riwayat daerah endemis.`, exam:`Splenomegali bisa ada.`, v,
    why:'Demam periodik + endemis ‚Üí malaria.'
  });},
  TB: ()=>{ const v=vitals({hr:[80,100], rr:[12,22], spo:[95,99]}); return makeCase({
    name:'Tuberkulosis paru (suspek)', tag:'Infeksi',
    chief:'Batuk >2 minggu, BB turun',
    story:`Keringat malam; kadang darah di dahak.`, exam:`Ronki halus apex.`, v,
    why:'Batuk lama + BB turun + night sweat ‚Üí curiga TB.'
  });},
  GE: ()=>{ const v=vitals({hr:[95,115], rr:[16,22], spo:[96,100], sbp:[95,115], dbp:[55,75]}); return makeCase({
    name:'Gastroenteritis dehidrasi', tag:'GI',
    chief:'Diare muntah',
    story:`Setelah makan di luar; feses tanpa darah.`, exam:`Turgor menurun, mulut kering.`, v,
    why:'Diare muntah akut + dehidrasi ‚Üí gastroenteritis.'
  });},
};

const TIER_DEF = {
  1: {name:'Dokter Belajar', max:20, pool:['Asma','Hypo','GE','Stone','Pyelo','Typhoid','Pn']},
  2: {name:'Dokter Magang',  max:20, pool:['Asma','Pn','HF','Appy','Chole','Pancrea','DKA','TB','Dengue','UGIB']},
  3: {name:'Dokter Ahli',    max:30, pool:['Sepsis','Ana','PTX','PE','ACS','Stroke','PreE','Ectopic','Malaria','UGIB','HF','Pn']},
};

/* ============ Game State ============ */
const BEST_KEY='dokdok_best_tier1';
let score=0, best=getStore(BEST_KEY,0)||0;
let tier=1, tierCount=0;
let currentCase=null, tries=0;
let usedDiseases=new Set();

/* ============ UI update ============ */
function updateTierLabel(){
  $('#tierLabel').textContent = `Tier ${tier} ‚Äî ${TIER_DEF[tier].name} (${tierCount}/${TIER_DEF[tier].max})`;
  $('#tierMax').textContent = TIER_DEF[tier].max;
  $('#tierProgress').textContent = tierCount;
}
function updateVitalsBars(v){
  $('#hr').textContent = v.HR || '‚Äî';
  $('#rr').textContent = v.RR || '‚Äî';
  $('#spo').textContent = v.SpO || '‚Äî';
  $('#bp').textContent = (v.BP && v.BP[0])? (v.BP[0]+'/'+v.BP[1]) : '‚Äî';
  const hrPct = clamp((v.HR-50)/100,0,1)*100;
  const rrPct = clamp((v.RR-10)/30,0,1)*100;
  const spPct = clamp((v.SpO-75)/25,0,1)*100;
  const bpPct = clamp(((v.BP?.[0]||0)-70)/70,0,1)*100;
  $('#hrB').style.width=hrPct+'%';
  $('#rrB').style.width=rrPct+'%';
  $('#spoB').style.width=spPct+'%';
  $('#bpB').style.width=bpPct+'%';
}
function resetUI(){
  $('#score').textContent=score; $('#best').textContent=best;
  $('#ident').textContent='‚Äî'; $('#chief').textContent='‚Äî'; $('#story').textContent='‚Äî';
  $('#exam').textContent='‚Äî'; $('#explain').textContent='';
  $('#options').innerHTML=''; $('#tries').textContent='‚Äî'; $('#revealBtn').disabled=true;
  updateVitalsBars({HR:0,RR:0,SpO:0,BP:[0,0]});
  $('#nayaTalk').textContent='‚ÄúGanbatte, dok!‚Äù ‚ú®';
  updateTierLabel();
}

/* ============ Case Generation ============ */
function genCaseByTier(){
  const pool = TIER_DEF[tier].pool;
  // Hindari pengulangan penyakit hingga semua dipakai
  let candidates = pool.filter(k=>!usedDiseases.has(k));
  if (candidates.length===0){ usedDiseases.clear(); candidates = pool.slice(); }
  const key = pick(candidates); usedDiseases.add(key);
  const maker = GEN[key];
  const c = maker();
  const age=rnd(17,78), sex=pick(['Laki-laki','Perempuan']);
  const name = uniquePatient();
  return { ...c, patient:`${name} ‚Ä¢ ${sex}, ${age} th` };
}
function newCase(){
  ensureAudio(); clickFx();
  if (tierCount>=TIER_DEF[tier].max){
    $('#nayaTalk').textContent = '‚ÄúTier selesai! Ganti tier atau ulang.‚Äù';
    return;
  }
  currentCase = genCaseByTier();
  // opsi (1 benar + 3 salah)
  const allNames = Object.values(GEN).map(fn=>fn().name);
  const wrongs = shuffle(allNames.filter(x=>x!==currentCase.name)).slice(0,3);
  const opts = shuffle([currentCase.name, ...wrongs]);
  // render
  $('#ident').textContent = currentCase.patient + ' ‚Ä¢ ' + currentCase.tag;
  $('#chief').textContent = currentCase.chief;
  $('#story').textContent = currentCase.story;
  $('#exam').textContent = currentCase.exam;
  updateVitalsBars(currentCase.v);
  $('#options').innerHTML = opts.map(o=>`
    <button class="btn" data-name="${o}">
      <span class="name">${o}</span>
      <span class="tag">${o===currentCase.name?'(paling mungkin)':''}</span>
    </button>
  `).join('');
  tries = (tier===3)?1:2; // ahli lebih ketat
  $('#tries').textContent = tries;
  $('#revealBtn').disabled = true;
  $('#explain').textContent='';
  bindOptionHandlers(currentCase.name);
  $('#nayaTalk').textContent = '‚ÄúPasien sudah di ranjang pemeriksaan, dok.‚Äù';
}
function bindOptionHandlers(correctName){
  $$('#options .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      ensureAudio(); clickFx();
      if (tries<=0) return;
      const chosen = btn.dataset.name;
      if (chosen === correctName){
        rightFx();
        btn.classList.add('correct');
        // skor: T1 +100, T2 +120, T3 +150
        const add = (tier===1?100:(tier===2?120:150));
        score += add; $('#score').textContent=score;
        const n=$('#avatarBig'); n.classList.remove('shake'); n.classList.add('bounce'); setTimeout(()=>n.classList.remove('bounce'), 400);
        $('#nayaTalk').textContent='‚ÄúTepat! Lanjut review ya.‚Äù';
        $('#revealBtn').disabled=false;
        tries=0; $('#tries').textContent='0';
        if (score>best){ best=score; setStore(BEST_KEY,best); $('#best').textContent=best; }
        tierCount++; updateTierLabel(); $('#tierProgress').textContent=tierCount;
      } else {
        wrongFx();
        btn.classList.add('wrong');
        const n=$('#avatarBig'); n.classList.remove('bounce'); n.classList.add('shake'); setTimeout(()=>n.classList.remove('shake'), 240);
        tries--; $('#tries').textContent=tries;
        $('#nayaTalk').textContent='‚ÄúCoba cocokkan pola gejala lagi~‚Äù';
        if (tries<=0){ $('#revealBtn').disabled=false; }
      }
    });
  });
}
$('#revealBtn').addEventListener('click', ()=>{
  ensureAudio(); hintFx();
  if (!currentCase) return;
  $('#explain').innerHTML =
    `üîé <b>Kenapa: ${currentCase.name}</b>\n`+
    `‚Ä¢ ${currentCase.why}\n\n`+
    `<i class="small">Ingat: ini gim edukasi untuk pola gejala, bukan panduan klinis.</i>`;
});

/* ============ Tier & Controls ============ */
$('#nextBtn').addEventListener('click', ()=> newCase());
$('#tierSel').addEventListener('change', ()=>{
  ensureAudio(); clickFx();
  tier = +$('#tierSel').value;
  tierCount = 0; usedDiseases.clear();
  $('#tierMax').textContent = TIER_DEF[tier].max;
  updateTierLabel(); resetUI();
});

/* ============ Profile Modal ============ */
function openProfile(){ $('#profileModal').style.display='flex'; renderAvatarChoices(); $('#nameInput').value = getStore('dok_name',''); }
function closeProfile(){ $('#profileModal').style.display='none'; }
$('#profileBtn').addEventListener('click', ()=>{ ensureAudio(); clickFx(); openProfile(); });
$('#closeProfile').addEventListener('click', ()=>{ clickFx(); closeProfile(); });
$('#saveProfile').addEventListener('click', ()=>{
  clickFx();
  const name = $('#nameInput').value.trim() || '‚Äî';
  setStore('dok_name', name);
  $('#docNameLabel').textContent = 'Dr. ' + name;
});
/* avatar init */
function initProfile(){
  const name = getStore('dok_name',''); $('#docNameLabel').textContent = 'Dr. ' + (name||'‚Äî');
  if (!getStore('dok_avatar', null)) setStore('dok_avatar','naya');
  drawAvatars();
}

/* ============ Init ============ */
function init(){
  $('#best').textContent = best;
  $('#tierMax').textContent = TIER_DEF[tier].max;
  updateTierLabel();
  resetUI();
  initProfile();
}
init();
</script>
</body>
</html>
